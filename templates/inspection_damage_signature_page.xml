<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Inspection Damage Signature Page Template -->
    <template id="inspection_damage_signature_page" name="Inspection Damage Acknowledgment">
        <t t-call="school_asset_management.signature_minimal_layout">
            <t t-set="head">
                <link rel="stylesheet" type="text/css" href="/school_asset_management/static/src/css/signature_page_minimal.css"/>
            </t>
            <div class="container damage-report-page mt-4 mb-5">
                <!-- Header -->
                <div class="text-center mb-4">
                    <h2 class="text-primary fw-bold">MYIS International School</h2>
                    <h4 class="text-secondary">Inspection Damage Report</h4>
                    <p class="text-muted">Please review the inspection findings and sign to acknowledge</p>
                </div>

                <!-- Alert Notice -->
                <div class="alert alert-warning shadow-sm" role="alert">
                    <h5 class="alert-heading">
                        <i class="fa fa-exclamation-triangle"></i> Damage Found During Routine Inspection
                    </h5>
                    <p class="mb-0">
                        Our IT department has identified damage to the asset assigned to your child during a routine inspection.
                        Please review the details below and sign to acknowledge receipt of this report.
                    </p>
                </div>

                <!-- Inspection Information Card -->
                <div class="card mb-4 shadow-sm">
                    <div class="card-header">
                        <h5 class="mb-0">Inspection Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <strong>Inspection Date:</strong>
                                <p class="mb-0"><t t-esc="inspection_date.strftime('%B %d, %Y') if inspection_date else 'N/A'"/></p>
                            </div>
                            <div class="col-md-4">
                                <strong>Inspection Type:</strong>
                                <p class="mb-0"><t t-esc="inspection_type"/></p>
                            </div>
                            <div class="col-md-4">
                                <strong>Inspector:</strong>
                                <p class="mb-0"><t t-esc="inspector_name"/></p>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <strong>Asset Code:</strong>
                                <p class="mb-0"><span class="badge bg-secondary"><t t-esc="asset_code"/></span></p>
                            </div>
                            <div class="col-md-6">
                                <strong>Asset Name:</strong>
                                <p class="mb-0"><t t-esc="asset_name"/></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Student Information Card -->
                <div class="card mb-4 shadow-sm">
                    <div class="card-header">
                        <h5 class="mb-0">Student Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <strong>Student Name:</strong>
                                <p class="mb-0"><t t-esc="student_name"/></p>
                            </div>
                            <div class="col-md-6">
                                <strong>Parent/Guardian:</strong>
                                <p class="mb-0"><t t-esc="parent_name"/> (<t t-esc="parent_email"/>)</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Damage Assessment -->
                <div class="card mb-4 shadow-sm">
                    <div class="card-header">
                        <h5 class="mb-0">Damage Assessment</h5>
                    </div>
                    <div class="card-body">
                        <!-- Condition Comparison -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <strong class="text-success">Previous Condition:</strong>
                                        <p class="mb-0 mt-2">
                                            <span t-attf-class="badge bg-{{ 'success' if condition_before == 'Excellent' else 'primary' if condition_before == 'Good' else 'warning' if condition_before == 'Fair' else 'danger' }}">
                                                <t t-esc="condition_before"/>
                                            </span>
                                        </p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <strong class="text-danger">Current Condition:</strong>
                                        <p class="mb-0 mt-2">
                                            <span t-attf-class="badge bg-{{ 'success' if condition_after == 'Excellent' else 'primary' if condition_after == 'Good' else 'warning' if condition_after == 'Fair' else 'danger' }}">
                                                <t t-esc="condition_after"/>
                                            </span>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Damage Description -->
                        <div class="card bg-warning bg-opacity-10 border-warning mb-3">
                            <div class="card-body">
                                <strong>Damage Description:</strong>
                                <p class="mb-0 mt-2"><t t-esc="damage_description or 'See inspection notes and photos'"/></p>
                            </div>
                        </div>

                        <!-- Repair Cost -->
                        <t t-if="repair_cost and repair_cost > 0">
                            <div class="row">
                                <div class="col-md-12 text-end">
                                    <span class="badge bg-danger fs-5">
                                        Estimated Repair Cost: $<t t-esc="'%.2f' % repair_cost"/>
                                    </span>
                                </div>
                            </div>
                        </t>

                        <!-- Inspection Photos -->
                        <t t-if="inspection.photo_ids">
                            <div class="mt-3">
                                <strong>Inspection Photos:</strong>
                                <div class="row g-2 mt-2">
                                    <t t-foreach="inspection.photo_ids[:6]" t-as="photo">
                                        <div class="col-md-4 col-sm-6">
                                            <img t-attf-src="data:image/png;base64,#{photo.datas}"
                                                 class="img-thumbnail"
                                                 alt="Inspection photo"
                                                 style="max-width: 100%; height: auto;"/>
                                        </div>
                                    </t>
                                </div>
                            </div>
                        </t>
                    </div>
                </div>

                <!-- Financial Responsibility Notice -->
                <t t-if="repair_cost and repair_cost > 0">
                    <div class="alert alert-info shadow-sm" role="alert">
                        <h6 class="alert-heading">
                            <i class="fa fa-info-circle"></i> Financial Responsibility
                        </h6>
                        <p class="mb-0">
                            As per the Student Asset Use Agreement, parents/guardians are financially responsible
                            for damage to school assets caused by negligence or misuse. The IT department will contact
                            you within 3-5 business days regarding payment arrangements for the repair costs listed above.
                        </p>
                    </div>
                </t>

                <!-- Signature Section Card -->
                <div class="card mb-4 shadow-sm">
                    <div class="card-header">
                        <h5 class="mb-0">Acknowledgment Signature</h5>
                    </div>
                    <div class="card-body">
                        <p class="fw-bold">
                            By signing below, I acknowledge that I have reviewed the inspection findings and damage assessment
                            <t t-if="repair_cost and repair_cost > 0">
                                and understand my financial responsibility for the repair costs.
                            </t>
                        </p>

                        <!-- Signature Canvas -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">
                                Signature of <t t-esc="parent_name"/> <span class="text-danger">*</span>
                            </label>
                            <div class="signature-pad-container border rounded p-2 bg-white">
                                <canvas id="signature-pad" class="signature-canvas"></canvas>
                            </div>
                            <div class="mt-2">
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="clear-signature">
                                    <i class="fa fa-eraser"></i> Clear Signature
                                </button>
                            </div>
                            <small class="form-text text-muted">
                                Sign above using your mouse or finger (on touch devices)
                            </small>
                        </div>

                        <!-- Submit Button -->
                        <div class="d-grid gap-2 mt-4">
                            <button type="button" class="btn btn-danger btn-lg" id="submit-inspection-damage-signature">
                                <i class="fa fa-check-circle"></i> Acknowledge Inspection Damage Report
                            </button>
                        </div>

                        <!-- Status Messages -->
                        <div id="status-message" class="mt-3" style="display: none;">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                </div>

                <!-- Hidden Token Field -->
                <input type="hidden" id="inspection_damage_token" t-att-value="token"/>
            </div>

            <!-- JavaScript for Signature Pad -->
            <script type="text/javascript" src="/school_asset_management/static/src/js/inspection_damage_signature_pad.js"></script>
        </t>
    </template>
</odoo>
