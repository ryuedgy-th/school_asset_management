<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Damage Report Page Template -->
    <template id="damage_report_page" name="Parent Damage Acknowledgment">
        <t t-call="school_asset_management.signature_minimal_layout">
            <t t-set="head">
                <link rel="stylesheet" type="text/css" href="/school_asset_management/static/src/css/signature_page.css"/>
            </t>
            <div class="container signature-page mt-4 mb-5">
                <!-- Header -->
                <div class="text-center mb-4">
                    <h2 class="text-primary fw-bold">MYIS International School</h2>
                    <h4 class="text-secondary">Asset Damage Report</h4>
                    <p class="text-muted">Please review the damage assessment and sign to acknowledge</p>
                </div>

                <!-- Alert Notice -->
                <div class="alert alert-warning shadow-sm" role="alert">
                    <h5 class="alert-heading">
                        <i class="fa fa-exclamation-triangle"></i> Damage Found During Check-in
                    </h5>
                    <p class="mb-0">
                        Our IT department has identified damage to the asset(s) returned by your child.
                        Please review the details below and sign to acknowledge receipt of this report.
                    </p>
                </div>

                <!-- Student Information Card -->
                <div class="card mb-4 shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Student Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <strong>Student Name:</strong>
                                <p class="mb-0"><t t-esc="student_name"/></p>
                            </div>
                            <div class="col-md-4">
                                <strong>Grade Level:</strong>
                                <p class="mb-0"><t t-esc="grade_level"/></p>
                            </div>
                            <div class="col-md-4">
                                <strong>Check-in Date:</strong>
                                <p class="mb-0"><t t-esc="checkin_date.strftime('%B %d, %Y') if checkin_date else 'N/A'"/></p>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-12">
                                <strong>Parent/Guardian:</strong>
                                <p class="mb-0"><t t-esc="parent_name"/> (<t t-esc="parent_email"/>)</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Damaged Assets Details -->
                <div class="card mb-4 shadow-sm">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">Damaged Assets</h5>
                    </div>
                    <div class="card-body">
                        <t t-foreach="damaged_assets" t-as="asset">
                            <div class="damage-item mb-4 pb-4 border-bottom">
                                <!-- Asset Header -->
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <h6 class="text-danger fw-bold">
                                            <i class="fa fa-warning"></i> <t t-esc="asset.asset_name"/>
                                        </h6>
                                        <p class="text-muted mb-0">
                                            <strong>Asset Code:</strong> <t t-esc="asset.asset_code"/>
                                        </p>
                                    </div>
                                    <div class="col-md-6 text-end">
                                        <span class="badge bg-danger fs-6">
                                            Repair Cost: $<t t-esc="'%.2f' % asset.repair_cost"/>
                                        </span>
                                    </div>
                                </div>

                                <!-- Condition Comparison -->
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <div class="card bg-light">
                                            <div class="card-body">
                                                <strong class="text-success">Checkout Condition:</strong>
                                                <p class="mb-0">
                                                    <span t-attf-class="badge bg-{{ 'success' if asset.checkout_condition == 'excellent' else 'primary' if asset.checkout_condition == 'good' else 'warning' if asset.checkout_condition == 'fair' else 'danger' }}">
                                                        <t t-esc="dict(asset._fields['checkout_condition'].selection).get(asset.checkout_condition, 'N/A')"/>
                                                    </span>
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card bg-light">
                                            <div class="card-body">
                                                <strong class="text-danger">Check-in Condition:</strong>
                                                <p class="mb-0">
                                                    <span t-attf-class="badge bg-{{ 'success' if asset.checkin_condition == 'excellent' else 'primary' if asset.checkin_condition == 'good' else 'warning' if asset.checkin_condition == 'fair' else 'danger' }}">
                                                        <t t-esc="dict(asset._fields['checkin_condition'].selection).get(asset.checkin_condition, 'N/A')"/>
                                                    </span>
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Damage Description -->
                                <div class="card bg-warning bg-opacity-10 border-warning">
                                    <div class="card-body">
                                        <strong>Damage Description:</strong>
                                        <p class="mb-0"><t t-esc="asset.damage_description or 'See photos below'"/></p>
                                    </div>
                                </div>

                                <!-- Damage Photos -->
                                <t t-if="asset.checkin_photo_ids">
                                    <div class="mt-3">
                                        <strong>Check-in Photos:</strong>
                                        <div class="row g-2 mt-2">
                                            <t t-foreach="asset.checkin_photo_ids" t-as="photo">
                                                <div class="col-md-4 col-sm-6">
                                                    <img t-attf-src="data:image/png;base64,#{photo.datas}"
                                                         class="img-thumbnail"
                                                         alt="Damage photo"
                                                         style="max-width: 100%; height: auto;"/>
                                                </div>
                                            </t>
                                        </div>
                                    </div>
                                </t>
                            </div>
                        </t>

                        <!-- Total Repair Cost -->
                        <div class="row mt-4">
                            <div class="col-md-12 text-end">
                                <h5 class="text-danger fw-bold">
                                    Total Repair Cost: $<t t-esc="'%.2f' % total_repair_cost"/>
                                </h5>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Financial Responsibility Notice -->
                <div class="alert alert-info shadow-sm" role="alert">
                    <h6 class="alert-heading">
                        <i class="fa fa-info-circle"></i> Financial Responsibility
                    </h6>
                    <p class="mb-0">
                        As per the Student Asset Use Agreement, parents/guardians are financially responsible
                        for damage caused by negligence or misuse. The IT department will contact you regarding
                        payment arrangements for the repair costs listed above.
                    </p>
                </div>

                <!-- Signature Section Card -->
                <div class="card mb-4 shadow-sm">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">Parent/Guardian Signature</h5>
                    </div>
                    <div class="card-body">
                        <p class="fw-bold">
                            By signing below, I acknowledge that I have reviewed the damage assessment
                            and understand my financial responsibility for the repair costs.
                        </p>

                        <!-- Signature Canvas -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">
                                Signature of <t t-esc="parent_name"/> <span class="text-danger">*</span>
                            </label>
                            <div class="signature-pad-container border rounded p-2 bg-white">
                                <canvas id="signature-pad" class="signature-canvas"></canvas>
                            </div>
                            <div class="mt-2">
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="clear-signature">
                                    <i class="fa fa-eraser"></i> Clear Signature
                                </button>
                            </div>
                            <small class="form-text text-muted">
                                Sign above using your mouse or finger (on touch devices)
                            </small>
                        </div>

                        <!-- Submit Button -->
                        <div class="d-grid gap-2 mt-4">
                            <button type="button" class="btn btn-success btn-lg" id="submit-damage-signature">
                                <i class="fa fa-check-circle"></i> Submit Signature
                            </button>
                        </div>

                        <!-- Status Messages -->
                        <div id="status-message" class="mt-3" style="display: none;">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                </div>

                <!-- Hidden Token Field -->
                <input type="hidden" id="damage_token" t-att-value="token"/>
            </div>

            <!-- JavaScript for Signature Pad -->
            <script type="text/javascript" src="/school_asset_management/static/src/js/damage_signature_pad.js"></script>
        </t>
    </template>
</odoo>
