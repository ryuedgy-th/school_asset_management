<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- Teacher Assignment Tree View -->
    <record id="view_asset_teacher_assignment_tree" model="ir.ui.view">
        <field name="name">asset.teacher.assignment.tree</field>
        <field name="model">asset.teacher.assignment</field>
        <field name="arch" type="xml">
            <list string="Teacher Assignments" decoration-info="status == 'draft'"
                  decoration-success="status == 'checked_in'"
                  decoration-warning="is_overdue == True"
                  decoration-muted="status == 'cancelled'">
                <field name="name"/>
                <field name="teacher_id"/>
                <field name="checkout_date"/>
                <field name="return_type"/>
                <field name="expected_return_date" optional="hide"/>
                <field name="actual_return_date"/>
                <field name="asset_count"/>
                <field name="status" widget="badge"
                       decoration-info="status == 'draft'"
                       decoration-warning="status == 'checked_out'"
                       decoration-success="status == 'checked_in'"/>
                <field name="is_overdue" invisible="1"/>
            </list>
        </field>
    </record>

    <!-- Teacher Assignment Form View -->
    <record id="view_asset_teacher_assignment_form" model="ir.ui.view">
        <field name="name">asset.teacher.assignment.form</field>
        <field name="model">asset.teacher.assignment</field>
        <field name="arch" type="xml">
            <form string="Teacher Assignment">
                <header>
                    <field name="status" invisible="1"/>
                    <field name="has_damage" invisible="1"/>
                    <field name="checkout_token_used" invisible="1"/>
                    <field name="damage_acknowledged" invisible="1"/>
                    <button name="action_checkout" string="Checkout" type="object"
                            class="btn-primary" invisible="status != 'draft'"/>
                    <button name="action_send_checkout_signature_request" string="Send Checkout Signature Request" type="object"
                            class="btn-info" icon="fa-envelope"
                            invisible="status != 'checked_out' or checkout_token_used == True"/>
                    <button name="action_checkin" string="Check-in" type="object"
                            class="btn-success" invisible="status != 'checked_out'"/>
                    <button name="action_send_damage_report" string="Send Damage Report" type="object"
                            class="btn-warning" icon="fa-exclamation-triangle"
                            invisible="has_damage == False or damage_acknowledged == True"/>
                    <button name="action_create_damage_case" string="Create Damage Case" type="object"
                            class="btn-danger" invisible="has_damage == False"/>
                    <button name="action_cancel" string="Cancel" type="object"
                            invisible="status not in ('draft', 'checked_out')"/>
                    <field name="status" widget="statusbar"
                           statusbar_visible="draft,checked_out,checked_in"/>
                </header>
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button name="action_view_assets" type="object"
                                class="oe_stat_button" icon="fa-cubes">
                            <field name="asset_count" widget="statinfo" string="Assets"/>
                        </button>
                        <button name="action_view_damage_cases" type="object"
                                class="oe_stat_button" icon="fa-exclamation-triangle"
                                invisible="damage_case_count == 0">
                            <field name="damage_case_count" widget="statinfo" string="Damage Cases"/>
                        </button>
                    </div>
                    <div class="oe_title">
                        <h1><field name="name" readonly="1"/></h1>
                    </div>
                    <group>
                        <group string="Teacher Information">
                            <field name="teacher_id"/>
                        </group>
                        <group string="Dates &amp; Return">
                            <field name="checkout_date"/>
                            <field name="return_type"/>
                            <field name="expected_return_date" invisible="return_type != 'specific_date'"/>
                            <field name="actual_return_date" readonly="1"/>
                            <field name="is_overdue" invisible="1"/>
                            <field name="days_overdue" invisible="return_type != 'specific_date'"/>
                        </group>
                    </group>
                    <notebook>
                        <page string="Assets">
                            <field name="asset_line_ids">
                                <list>
                                    <field name="asset_id" domain="[('status', '=', 'available')]"/>
                                    <field name="asset_code"/>
                                    <field name="asset_name"/>
                                    <field name="asset_category"/>
                                    <field name="checkout_condition"/>
                                    <field name="checkin_condition"/>
                                    <field name="damage_found"/>
                                    <field name="repair_cost" sum="Total Repair Cost"/>
                                </list>
                            </field>
                            <p class="text-muted">Click on an asset line to view/add photos and detailed notes</p>
                        </page>
                        <page string="Teacher Signature">
                            <group>
                                <group string="Teacher Information">
                                    <field name="teacher_id" readonly="1"/>
                                    <field name="teacher_email" readonly="1"/>
                                </group>
                                <group string="Checkout Signature Status">
                                    <field name="checkout_token_used" readonly="1"/>
                                    <field name="checkout_sign_date" readonly="1"/>
                                    <field name="checkout_token_expiry" readonly="1" invisible="not checkout_token_expiry"/>
                                </group>
                            </group>

                            <separator string="Checkout Signature Request"/>
                            <group>
                                <group>
                                    <button name="action_send_checkout_signature_request"
                                            string="📧 Send Checkout Signature Request"
                                            type="object"
                                            class="btn-primary"
                                            icon="fa-envelope"
                                            invisible="checkout_token_used == True"/>

                                    <button name="action_copy_checkout_link"
                                            string="🔗 Copy Signature Link"
                                            type="object"
                                            class="btn-info"
                                            icon="fa-copy"
                                            invisible="not checkout_token or checkout_token_used == True"
                                            help="Copy link to send via LINE/WhatsApp"/>
                                </group>
                                <group>
                                    <button name="action_view_checkout_pdf"
                                            string="📄 View Signed Waiver PDF"
                                            type="object"
                                            class="btn-success"
                                            icon="fa-file-pdf-o"
                                            invisible="not checkout_signed_pdf_id"/>
                                </group>
                            </group>

                            <!-- Display Teacher Signature (if signed) - WATERMARKED FOR SECURITY -->
                            <group string="Teacher Signature (Checkout)" invisible="not checkout_teacher_signature">
                                <field name="checkout_teacher_signature" invisible="1"/>
                                <field name="checkout_teacher_signature_watermarked" widget="image" nolabel="1"
                                       options="{'size': [400, 100]}" readonly="1"
                                       help="Watermarked signature for display only. Original stored securely."/>
                                <field name="checkout_ip_address" readonly="1"/>
                            </group>

                            <separator string="Damage Report" invisible="not has_damage"/>
                            <group invisible="not has_damage">
                                <group>
                                    <field name="damage_acknowledged" readonly="1"/>
                                    <field name="damage_acknowledge_date" readonly="1" invisible="not damage_acknowledged"/>
                                </group>
                                <group>
                                    <button name="action_send_damage_report"
                                            string="⚠️ Send Damage Report to Teacher"
                                            type="object"
                                            class="btn-warning"
                                            icon="fa-exclamation-triangle"
                                            invisible="damage_acknowledged"/>

                                    <button name="action_copy_damage_link"
                                            string="🔗 Copy Damage Report Link"
                                            type="object"
                                            class="btn-info"
                                            icon="fa-copy"
                                            invisible="not damage_report_token or damage_acknowledged"
                                            help="Copy link to send via LINE/WhatsApp"/>

                                    <button name="action_view_damage_pdf"
                                            string="📄 View Signed Damage Report"
                                            type="object"
                                            class="btn-info"
                                            icon="fa-file-pdf-o"
                                            invisible="not damage_signed_pdf_id"/>
                                </group>
                            </group>

                            <!-- Display Damage Signature (if signed) - WATERMARKED FOR SECURITY -->
                            <group string="Teacher Damage Acknowledgment Signature" invisible="not damage_signature">
                                <field name="damage_signature" invisible="1"/>
                                <field name="damage_signature_watermarked" widget="image" nolabel="1"
                                       options="{'size': [400, 100]}" readonly="1"
                                       help="Watermarked signature for display only. Original stored securely."/>
                                <field name="damage_acknowledge_ip" readonly="1"/>
                            </group>

                            <separator string="IT Staff Signature (Check-in)"/>
                            <group string="IT Staff Signature">
                                <group>
                                    <field name="checkin_it_signature" widget="signature" options="{'size': [400, 100]}"/>
                                    <field name="checkin_it_user_id"/>
                                    <field name="checkin_sign_date"/>
                                </group>
                            </group>
                        </page>
                        <page string="Notes">
                            <field name="notes"/>
                        </page>
                    </notebook>
                </sheet>
                <chatter/>
            </form>
        </field>
    </record>

    <!-- Teacher Assignment Action -->
    <record id="action_asset_teacher_assignment" model="ir.actions.act_window">
        <field name="name">Teacher Assignments</field>
        <field name="res_model">asset.teacher.assignment</field>
        <field name="view_mode">list,form</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Create your first teacher assignment
            </p>
        </field>
    </record>

</odoo>
